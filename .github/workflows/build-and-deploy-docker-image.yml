name: Build and Deploy Docker Image

on:
  push:
    branches:
    - main

jobs:
  build:
    runs-on: ubuntu-kinetic

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ sercrets.DOCKERHUB_USERNAME }}
          password: ${{ sercrets.DOCKERHUB_TOKEN }}
      - name: Build Docker image
        run: |
         echo "=== Build start==="
         echo ${{ github.head_ref }}
        
         cd dockerfiles
         docker build --force-rm -f build.dockerfile -t "proslam:2.1" --build-arg BRANCH=${{ github.head_ref }} . 
         echo "=== Build finished==="
         
      - name: Clean up Docker image if build fails
        if: failure()
        run: |
         echo "=== Remove failed image start==="
         docker rmi -f $(docker images -f "dangling=true" -q)
         docker images 
         echo "=== Removal finished==="
